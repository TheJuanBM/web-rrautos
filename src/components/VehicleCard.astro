---
import type { Vehiculo } from '../types'
import { extractFirstLink } from '../utils'
import OptimizedImage from './OptimizedImage.astro'

interface Props {
  vehiculo: Vehiculo
  priority?: boolean
}

const { vehiculo, priority = false } = Astro.props
const enlaceCompleto = extractFirstLink(vehiculo.description)
const vehicleId = `vehicle-${vehiculo.id}`
---

<article
  class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm hover:shadow-md transition focus-within:ring-2 focus-within:ring-blue-500 focus-within:ring-offset-2"
  role="article"
  aria-labelledby={`${vehicleId}-title`}
  itemscope
  itemtype="https://schema.org/Car"
>
  <div
    class="w-full h-28 md:h-32 relative overflow-hidden rounded-md bg-gray-100 vehicle-image-container"
    role="img"
    aria-label={`Imagen de ${vehiculo.title}`}
  >
    {
      vehiculo.ribbon_text && (
        <span
          class="absolute top-2 right-2 bg-green-600 text-[11px] font-bold px-2 py-0.5 rounded-full shadow z-10"
          role="status"
          aria-label={`Oferta especial: ${vehiculo.ribbon_text}`}
        >
          {vehiculo.ribbon_text}
        </span>
      )
    }
    <OptimizedImage
      src={vehiculo.thumbnail}
      alt={`${vehiculo.title} - Vehículo usado disponible en RR Autos`}
      width={320}
      height={240}
      class="w-full h-full object-cover"
      priority={priority}
      sizes="(max-width: 640px) 100vw, (max-width: 768px) 50vw, (max-width: 1024px) 33vw, 25vw"
    />
  </div>

  <div class="mt-2">
    <h3 id={`${vehicleId}-title`} class="text-sm font-semibold text-contrast-high line-clamp-2" itemprop="name">
      {vehiculo.title}
    </h3>

    <a
      href={enlaceCompleto}
      target="_blank"
      rel="noopener noreferrer"
      class="inline-flex items-center gap-1 text-blue-600 hover:underline text-sm font-medium mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 rounded"
      aria-label={`Ver más detalles de ${vehiculo.title} (se abre en nueva ventana)`}
      itemprop="url"
    >
      <span>Ver más detalles</span>
      <svg class="w-4 h-4" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path fill="currentColor" d="M13.172 12L8.222 7.05l1.414-1.414L16 12l-6.364 6.364-1.414-1.414z"></path>
      </svg>
      <svg class="w-3 h-3 ml-1" viewBox="0 0 24 24" aria-label="Enlace externo" focusable="false">
        <path
          fill="currentColor"
          d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"
        ></path>
      </svg>
    </a>
  </div>

  <!-- Schema.org structured data para el vehículo -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'Car',
      name: vehiculo.title,
      image: vehiculo.thumbnail,
      url: enlaceCompleto,
      offers: {
        '@type': 'Offer',
        availability: 'https://schema.org/InStock',
        priceCurrency: 'COP',
        seller: {
          '@type': 'AutoDealer',
          name: 'RR Autos',
        },
      },
    })}
  />
</article>
